# Lite-HRNet-18 网络架构设计说明书 - Stage2

## Stage2 详细说明

### 目标
在维持 **1/4 高分辨率分支** 的同时，新建 **1/8 分支**，并做一次 **HRNet 式跨尺度融合**，让高层语义与低层几何双向流动而不破坏边界尖锐性。

## 2.0 模块列表（按执行顺序）

### 2.0.1 Transition（从 Stage1 建立双分支）

- **T2.b1_keep**: 1×1 Conv(32→32), BN, SiLU，保持 1/4 分支
  - 输入/输出：`[B,32,64,128] → [B,32,64,128]`

- **T2.b2_down**: DWConv 3×3(s=2,p=1) + PW 1×1(32→64), BN, SiLU，新建 1/8 分支
  - 输入/输出：`[B,32,64,128] → [B,64,32,64]`

得到：
- `S2_1/4_in = [B,32,64,128]`
- `S2_1/8_in = [B,64,32,64]`

### 2.0.2 每分支残差块（轻量 LiteBlock，MBConv 风格，e=2）

- **1/4 分支**：`LiteBlock(32,e=2,s=1) × 2`
  - `S2_1/4_in → S2_1/4_mid = [B,32,64,128]`

- **1/8 分支**：`LiteBlock(64,e=2,s=1) × 2`
  - `S2_1/8_in → S2_1/8_mid = [B,64,32,64]`

> LiteBlock 结构：PW-Expand 1×1(C→eC) → DWConv 3×3(s=1) → PW-Project 1×1(eC→C)，每层后 BN+SiLU；若 s=1 且 Cin=Cout 用残差。

### 2.0.3 跨尺度融合（CRF-2）（与 HRNet 同型：对齐→相加→平滑）

- **到 1/4 分支：**
  - 上采 `S2_1/8_mid`：`Up2(bilinear, align_corners=False)` + 1×1(64→32) 通道对齐
  - 与 `S2_1/4_mid` 相加 → 3×3(32→32) + BN + SiLU 平滑
  - **输出 `Y1 = [B,32,64,128]`**

- **到 1/8 分支：**
  - 下采 `S2_1/4_mid`：DWConv 3×3(s=2,p=1) + PW 1×1(32→64) 对齐
  - 与 `S2_1/8_mid` 相加 → 3×3(64→64) + BN + SiLU 平滑
  - **输出 `Y2 = [B,64,32,64]`**

> 上采用双线性（更稳定）；下采优先 DWConv s=2（抗走样，代价低）。相加后都接一层 3×3 "smooth conv" 稳定分布。

---

## 2.1 逐层 I/O 与细节

### Transition

- **T2.b1_keep**:
  - 输入/输出：`[B,32,64,128] → [B,32,64,128]`
  - 用途：轻投影，后续分支通道统一

- **T2.b2_down**:
  - 输入/输出：`[B,32,64,128] → [B,64,32,64]`
  - 用途：建立 1/8 语义分支，并把通道扩到 64，以容纳更抽象的特征

### 分支块

- **Block_1/4 ×2**：每块保持尺寸 64×128, C=32，增强局部几何/边界
- **Block_1/8 ×2**：每块保持尺寸 32×64, C=64，增强区块级语义与形状先验

### 融合（CRF-2）

- **到 1/4**：`Up(S2_1/8_mid 64c → 32c)` 与 `S2_1/4_mid` 相加 → `3×3` 平滑
  - 输出 `Y1=[B,32,64,128]`

- **到 1/8**：`Down(S2_1/4_mid 32c → 64c)` 与 `S2_1/8_mid` 相加 → `3×3` 平滑
  - 输出 `Y2=[B,64,32,64]`

---

## 2.2 设计动机（为你的任务量身）

- **保持 1/4 高分支**：后续你要在 1/4 上做中心热图/偏移或边界密集预测，维持细节是拿到 ≤2px 的关键
- **1/8 语义分支**：承载全局上下文与假缺口判别所需的"语义差异"
- **一次融合就够**：在 Stage2 做一次 CRF，既把 1/8 的语义注入 1/4，又把 1/4 的边界传回 1/8，避免多次反复融合导致边界软化

---

## 3 补充说明

### 3.1 Up2(bilinear, align_corners=False) —— 空间分辨率上采样
- 使用双线性插值进行 2 倍上采样
- align_corners=False 确保边界像素对齐正确
- 更稳定的梯度传播

### 3.2 为什么 DWConv s=2 能抗走样（anti-aliasing）
- 深度可分离卷积在下采样时天然具有低通滤波特性
- stride=2 减少高频噪声
- 计算代价低于传统卷积