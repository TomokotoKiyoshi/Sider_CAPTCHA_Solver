# Lite-HRNet-18 网络架构设计说明书 - Stage3

## Stage3 详细说明

## 3.0 模块列表（执行顺序）

### (A) Transition3：建立 1/16 分支

- **T3.b3_from_1_8**：从 1/8 下采到 1/16
  - 结构：DWConv 3×3(s=2,p=1) → PW 1×1(64→128) → BN → SiLU
  - I/O：`Y2 [B,64,32,64] → Z3_in [B,128,16,32]`

得到三路输入：
- `Z1_in = Y1 = [B,32,64,128]`（1/4）
- `Z2_in = Y2 = [B,64,32,64]`（1/8）
- `Z3_in = [B,128,16,32]`（1/16，新建）

### (B) 分支主体：LiteBlock ×3（e=2）

- **Branch_1/4**：`LiteBlock(32,e=2) ×3`
  - I/O：`Z1_in → Z1_mid = [B,32,64,128]`

- **Branch_1/8**：`LiteBlock(64,e=2) ×3`
  - I/O：`Z2_in → Z2_mid = [B,64,32,64]`

- **Branch_1/16**：`LiteBlock(128,e=2) ×3`
  - I/O：`Z3_in → Z3_mid = [B,128,16,32]`

> LiteBlock：PW-Expand 1×1(C→2C) → DW 3×3 → PW-Project 1×1(2C→C)
> - PW-Expand后：BN+SiLU激活
> - DW后：BN+SiLU激活
> - PW-Project后：仅BN，**无激活函数**（线性输出）
> - s=1 且 Cin=Cout 使用残差连接

### (C) 跨尺度融合（CRF-3，HRNet 风格：对齐→相加→平滑）

我们对**每个目标分支**，把其他两支通过上/下采样与 1×1 对齐到相同分辨率与通道后**相加**，再接一层 3×3 "smooth conv"。

#### 汇到 1/4（输出 `T1`）
- 来自 1/4：`Z1_mid` 直接参与
- 来自 1/8：`Up2(Z2_mid)` → 1×1(64→32)
- 来自 1/16：`Up4(Z3_mid)` → 1×1(128→32)
- 求和 → 3×3(32→32)+BN+SiLU
- **`T1 = [B,32,64,128]`**

#### 汇到 1/8（输出 `T2`）
- 来自 1/8：`Z2_mid` 直接参与
- 来自 1/4：`Down2(Z1_mid)`：DW 3×3(s=2) → 1×1(32→64)
- 来自 1/16：`Up2(Z3_mid)` → 1×1(128→64)
- 求和 → 3×3(64→64)+BN+SiLU
- **`T2 = [B,64,32,64]`**

#### 汇到 1/16（输出 `T3`）
- 来自 1/16：`Z3_mid` 直接参与
- 来自 1/8：`Down2(Z2_mid)`：DW 3×3(s=2) → 1×1(64→128)
- 来自 1/4：`Down4(Z1_mid)`：DW 3×3(s=2)×2 → 1×1(32→128)
- 求和 → 3×3(128→128)+BN+SiLU
- **`T3 = [B,128,16,32]`**

> 说明：上采样用双线性（align_corners=False），下采样优先 DW s=2（可在 DW 前加可选 BlurPool 做抗锯齿）。跨尺度统一通道全部用 1×1。融合后 3×3 smooth 能稳定统计、抑制对齐误差。

---

## 3.1 逐层 I/O 一览（便于抄代码）

- **输入**：
  - `Y1=[B,32,64,128]`，`Y2=[B,64,32,64]`

- **Transition3**：
  - `Y2 → Z3_in=[B,128,16,32]`

- **分支块（×3）**：
  - `Z1_in → Z1_mid=[B,32,64,128]`
  - `Z2_in → Z2_mid=[B,64,32,64]`
  - `Z3_in → Z3_mid=[B,128,16,32]`

- **融合（CRF-3）**：
  - `T1=[B,32,64,128]`，`T2=[B,64,32,64]`，`T3=[B,128,16,32]`

> 这些 T1/T2/T3 会作为 Stage4 的输入（在 Stage4 我们会再新增 1/32 分支并做 CRF-4）。

---

## 3.2 设计动机（与你任务的对应关系）

- **1/16 分支**：提供更强的全局语义，用于压制 *confusing_gap* 的伪峰、吸收 size_confusion 带来的尺度/上下文差异
- **1/4 分支**：保持边界与像素几何细节，为 <2px 的定位打底
- **一次 CRF-3**：就足够把三路信息打通，避免过度反复融合导致边界软化，尤其在 *highlight* 与 *hollow_center* 下保持尖锐

---

## 3.4 实现要点（数值稳定 & 鲁棒性）

- **对齐顺序**：先空间对齐（Up/Down），再用 1×1 做通道对齐，最后相加
- **BN 动量**：可稍大（如 0.1）以适应 35 万张的合成域分布；融合后 smooth 层的 BN γ 可初始化得略小（0.9）
- **注意力（可选小权重）**：在相加前放一个轻量 SE/Coord-Attention，但建议**权重小**，避免把 Perlin/高光的高频带进 1/4 分支
- **抗 alias**：下采样前用 BlurPool 或者把 DW s=2 前加一个固定 3×3 平滑核，能再降 0.05-0.1px 的抖动误差