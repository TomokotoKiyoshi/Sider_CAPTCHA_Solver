# Lite-HRNet-18 网络架构设计说明书 - Stage4

## Stage4 详细说明

**目标**：在保持 1/4～1/16 的细节与中层语义同时，引入 **1/32=256c** 的全局语义分支；随后进行一次**四分支跨尺度融合**，得到最终的并行表征，供下游 FPN/Head 使用。

## 4.0 模块列表（执行顺序）

### (A) Transition4：建立 1/32 分支

- 从 1/16 下采到 1/32
  - 结构：`DWConv 3×3 (s=2,p=1) → PW 1×1 (128→256) → BN → SiLU`
  - I/O：`T3 [B,128,16,32] → S4_in [B,256,8,16]`

得到四路输入：
- `U1_in=T1=[B,32,64,128]`（1/4）
- `U2_in=T2=[B,64,32,64]`（1/8）
- `U3_in=T3=[B,128,16,32]`（1/16）
- `U4_in=S4_in=[B,256,8,16]`（1/32，新建）

### (B) 分支主体（轻量 LiteBlock，e=2）

推荐每分支 **×2**（足够；如追求更稳可 ×3）：

- 1/4：`LiteBlock(32)×2` → `U1_mid=[B,32,64,128]`
- 1/8：`LiteBlock(64)×2` → `U2_mid=[B,64,32,64]`
- 1/16：`LiteBlock(128)×2` → `U3_mid=[B,128,16,32]`
- 1/32：`LiteBlock(256)×2` → `U4_mid=[B,256,8,16]`

### (C) 跨尺度融合（CRF-4，HRNet 风格）

对每个目标分支，把其它三支对齐到相同分辨率与通道后**逐元素相加**，再用 3×3"smooth conv"稳定分布。

#### 汇到 1/4（输出 B1）
- 来自 1/4：`U1_mid`
- 来自 1/8：`Up2(U2_mid) → 1×1(64→32)`
- 来自 1/16：`Up4(U3_mid) → 1×1(128→32)`
- 来自 1/32：`Up8(U4_mid) → 1×1(256→32)`
- 求和 → `3×3(32→32)+BN+SiLU` → **`B1=[B,32,64,128]`**

#### 汇到 1/8（输出 B2）
- 来自 1/8：`U2_mid`
- 来自 1/4：`Down2(U1_mid)：DW s=2 → 1×1(32→64)`
- 来自 1/16：`Up2(U3_mid) → 1×1(128→64)`
- 来自 1/32：`Up4(U4_mid) → 1×1(256→64)`
- 求和 → `3×3(64→64)+BN+SiLU` → **`B2=[B,64,32,64]`**

#### 汇到 1/16（输出 B3）
- 来自 1/16：`U3_mid`
- 来自 1/8：`Down2(U2_mid)：DW s=2 → 1×1(64→128)`
- 来自 1/4：`Down4(U1_mid)：DW s=2×2 → 1×1(32→128)`
- 来自 1/32：`Up2(U4_mid) → 1×1(256→128)`
- 求和 → `3×3(128→128)+BN+SiLU` → **`B3=[B,128,16,32]`**

#### 汇到 1/32（输出 B4）
- 来自 1/32：`U4_mid`
- 来自 1/16：`Down2(U3_mid)：DW s=2 → 1×1(128→256)`
- 来自 1/8：`Down4(U2_mid)：DW s=2×2 → 1×1(64→256)`
- 来自 1/4：`Down8(U1_mid)：DW s=2×3 → 1×1(32→256)`
- 求和 → `3×3(256→256)+BN+SiLU` → **`B4=[B,256,8,16]`**

> 上采样：bilinear（align_corners=False）；下采样：DW s=2（可选前置 BlurPool）；所有通道对齐均用 1×1；融合后必接 3×3 smooth。

### (D) Stage4 输出

- `B1=[B,32,64,128]`
- `B2=[B,64,32,64]`
- `B3=[B,128,16,32]`
- `B4=[B,256,8,16]`

这是**主干最终四分支**，将直接侧连到 **LiteFPN(128c)**。

---

## 补充说明

### Up2 的推荐实现（默认）

- **算子**：双线性上采样（bilinear），`align_corners=False`
- **公式**：PyTorch 内部用
  
  x_in = (x_out + 0.5) / s - 0.5  (s=2)
  
  保证整倍数放大时像素中心对齐、无系统性偏移。