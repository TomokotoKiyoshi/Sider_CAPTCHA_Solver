# Lite-HRNet-18 网络架构设计说明书 - LiteFPN（128c）与高分辨率聚合

## 0. 入口与目标

来自 Stage4 的四分支（形状固定）：
- `B1` = [B, **32**, 64,128]（1/4）
- `B2` = [B, **64**, 32, 64]（1/8）
- `B3` = [B, **128**, 16, 32]（1/16）
- `B4` = [B, **256**, 8, 16]（1/32）

LiteFPN 的目标是：统一低分辨率语义到 **128 通道**，逐级上采回 **1/4 分辨率**，并和高分辨率分支 `B1` 融合，得到主特征：

- `Hf` = [B, **128**, 64,128]（1/4，用于密集头：热图/偏移/边界/SDF 等）

同时保留中间金字塔（用于辅助监督或候选/排序的侧用）：
- `P3_td` = [B,128, 32,64]
- `P4_td` = [B,128, 16,32]
- `P5` = [B,128, 8,16]

---

## 1. 侧连（统一到 128c）

将各尺度通道先用 1×1 投影到 128：

- `L5`: 1×1(256→128) 作用于 `B4` → `P5` = [B,128,8,16]
- `L4`: 1×1(128→128) 作用于 `B3` → `P4` = [B,128,16,32]
- `L3`: 1×1( 64→128) 作用于 `B2` → `P3` = [B,128,32,64]
- （可选）`L2`: 1×1( 32→128) 作用于 `B1` → `H2_128` = [B,128,64,128]，供最后融合用

> 说明：侧连用 bias=False 的 1×1 Conv + BN，初始化 Kaiming；保持轻量同时做通道对齐。

---

## 2. 自顶向下（Top-Down）逐级上采与融合

### 2.1 从 1/32 到 1/16

- 先在最低层做一次 3×3 平滑（减少量化/抽样噪声）
  
  `P5s = Conv3×3(128→128, padding=1) (BN+SiLU) (P5) → [B,128, 8,16]`

- 上采到 1/16：
  
  `U5 = Up2(P5s)` → [B,128,16,32]（双线性，`align_corners=False`）

- 融合 1/16：
  
  `F4 = Fuse(U5, P4)` → 融合后再 `Conv3×3(128→128)` 平滑
  
  得 `P4_td` = [B,128,16,32]

### 2.2 从 1/16 到 1/8

- 上采：`U4 = Up2(P4_td)` → [B,128,32,64]
- 融合 1/8：
  
  `F3 = Fuse(U4, P3)` → `Conv3×3` 平滑
  
  得 `P3_td` = [B,128,32,64]

### 2.3 从 1/8 到 1/4 + 与 HR 分支聚合

- 上采：`U3 = Up2(P3_td)` → [B,128,64,128]
- 与 HR 分支融合（两种方式，推荐"加和"）：
  - **方式 A（推荐，轻量稳定）**：
    
    `Hr = 1×1(B1:32→128)` → [B,128,64,128]
    
    `Hf = Smooth3×3( Hr + U3 )` → [B,128,64,128]
    
  - **方式 B（Concat，更灵活）**：
    
    `Hf = Conv3×3( (Hr ⊕ U3):256 → 128 )`（⊕为通道拼接）
    
    能更强表达，但略增算量/显存

> Smooth3×3 都带 BN+SiLU，强烈建议在融合后做一次，以对齐统计和抑制上采样细抖。

---

## 3. 融合函数 Fuse 的三种实现

设要融合的两张 128c 的特征图 `A`、`B`（一般为上一层上采结果与当前侧连）：

### 3.1 直接相加（最轻，默认）

F = A + B

优点：零参数、快；缺点：不同尺度占比不可学。

### 3.2 可学习权重（BiFPN 风格，推荐）

引入非负权重 w_A, w_B（Softplus 保证 ≥0），并做归一化：

w̃_A = softplus(w_A) / (softplus(w_A) + softplus(w_B) + ε)
w̃_B = softplus(w_B) / (softplus(w_A) + softplus(w_B) + ε)

F = w̃_A · A + w̃_B · B

然后接 `Conv3×3+BN+SiLU`。这在 **size_confusion** 和 **confusing_gap** 情况下更稳。

### 3.3 通道注意力门控（可选，小权重）

在相加/加权前，对每个输入加一个 SE/Coord-Att 的门控，限制高频噪声（Perlin/高光）扩散。默认**关**；遇到强高光数据可开。

---

## 4. 上/下采样与对齐细节（避免亚像素漂移）

- 上采：`F.interpolate(..., scale_factor=2, mode='bilinear', align_corners=False)`
  
  与之前的 Up2 保持一致，避免累计 0.5px 漂移。

- 下采（若做 PAN/辅助路径）：**DWConv s=2** 或 AvgPool2d(2)，可选 `anti-alias`（先 3×3 blur 再采样）。

- 所有上/下采后**先做空间尺寸对齐**，再做 1×1 通道匹配，最后融合并 Smooth3×3。

---

## 5. 数值稳定与初始化

- 所有 1×1、3×3 卷积：Kaiming 正态，`bias=False`，BN 的 γ 初始化为 1.0；**融合后的 Smooth3×3 的 BN γ 可设 0.9** 稍微保守。
- 可学习权重法（BiFPN 风格）：初值 w_A = w_B = 1.0；ε = 10^-4。
- AMP + `channels_last` 建议开启；batch=256 @ 32GB 没问题。

---

## 6. 逐层 I/O 速查表（完全可照抄）

以 **方式 A（加和）** 为例：

- `P5 = L5(B4)` → [B,128, 8,16]
- `P5s = S5(P5)`（3×3）→ [B,128,8,16]
- `U5 = Up2(P5s)` → [B,128,16,32]
- `P4_td = S4( U5 + P4 )` → [B,128,16,32]
- `U4 = Up2(P4_td)` → [B,128,32,64]
- `P3_td = S3( U4 + P3 )` → [B,128,32,64]
- `U3 = Up2(P3_td)` → [B,128,64,128]
- `Hr = L2(B1)` → [B,128,64,128]
- `Hf = S2( Hr + U3 )` → **[B,128,64,128]**

> 若启用方式 B（Concat），把 Hr + U3 换成 Concat(Hr,U3) 再 Conv3×3(256→128)。

---

## 7. 附录解释

### 7.1 softplus
- 定义：softplus(x) = log(1 + exp(x))
- 特性：平滑版本的 ReLU，保证输出非负
- 用途：在 BiFPN 权重归一化中确保权重非负