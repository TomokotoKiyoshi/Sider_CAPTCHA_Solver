# Lite-HRNet-18 网络架构设计说明书 - 预测头

## 核心设计理念

### 统一特征图策略

- 我们先用主干（Lite-HRNet-18）+ LiteFPN 把多尺度信息**汇到一张特征图**：
  
  **Hf = [B, 128, 64, 128]**（也就是原图 256×512 的 **1/4 分辨率**）

- **全部预测头**（heatmap、子像素偏移、可选角度、可选边界）**都挂在这张 Hf 上**做密集预测，不再在 1/8、1/16 等多尺度上各自建头

这样做的含义：**所有要输出的密集图或坐标，统一在 64×128 的栅格上产生**，再映射回原图坐标。

## 为什么统一在 1/4 上做？

### 1. 精度与开销折中最佳

1/4 的网格间距是 4 像素。配合**子像素偏移**（每格内的连续偏移 ∈[-0.5,0.5]）与 **soft-argmax/DSNT**，量化误差可以压到 <1px，满足要求的 **≤2px**；同时计算量比 1/2 或 1/1 小很多，batch=256 更稳。

### 2. 对齐简单且稳定

多个头都共用同一张 Hf，**没有跨尺度对齐误差**，训练/解码逻辑更干净。

### 3. 保边界细节 + 吃到语义

Hf 来自"高分辨分支（HR）直通 + 低分辨语义（FPN）回注"，既有边界细节也有全局上下文，对 *highlight / hollow_center / confusing_gap* 更鲁棒。

## 具体预测头定义

以 **Base** 版为例，全部在 Hf=[B,128,64,128] 上：

### 1. 双中心热力图头（找真实缺口中心、拼图中心）

- **结构**：`3×3,128→64 → ReLU → 1×1,64→1 → Sigmoid`
- **输出**：
  - `H_gap=[B,1,64,128]`
  - `H_piece=[B,1,64,128]`
- **作用**：每张热图在各自中心处形成高斯峰（CenterNet 思路），峰值位置就是栅格级坐标

### 2. 子像素偏移头（把栅格内再细分）

- **结构**：`3×3,128→64 → ReLU → 1×1,64→4`（可用 tanh 限幅到 ±0.5）
- **输出**：`O=[B,4,64,128]`，顺序 `(du_gap, dv_gap, du_piece, dv_piece)`（单位：**栅格单位**）
- **作用**：给出每个中心在所属栅格内的连续偏移，配合热力图能实现**亚像素**定位

### 3. 角度头（可选）

- **结构**：`3×3 → 1×1 → L2 normalize`
- **输出**：`θ=[B,2,64,128]`（表示 `sinθ, cosθ`）
- **作用**：建模数据里"gap 微旋转（±~2°）"，有助于压假峰与细修几何一致性