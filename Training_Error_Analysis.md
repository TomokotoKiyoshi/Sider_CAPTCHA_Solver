# è®­ç»ƒé”™è¯¯åˆ†ææŠ¥å‘Š

**ç”Ÿæˆæ—¶é—´**: 2025-08-16  
**åˆ†æç›®æ ‡**: scripts/training/train.py è¿è¡Œé”™è¯¯

---

## ğŸ“‹ é”™è¯¯æ¦‚è§ˆ

è¿è¡Œè®­ç»ƒè„šæœ¬æ—¶é‡åˆ°3ä¸ªä¸»è¦é—®é¢˜ï¼š
1. **TensorBoardæ— æ•°æ®æ˜¾ç¤º** (ä½ä¼˜å…ˆçº§)
2. **å¼ é‡ç»´åº¦ä¸åŒ¹é…å¯¼è‡´å´©æºƒ** (é«˜ä¼˜å…ˆçº§) âš ï¸ 
3. **æ¨¡å‹ç»“æ„å›¾æ— æ³•ç”Ÿæˆ** (ä½ä¼˜å…ˆçº§)

---

## ğŸ” è¯¦ç»†åˆ†æ

### é”™è¯¯1: TensorBoardæ— æ•°æ®æ˜¾ç¤º

**é”™è¯¯ä¿¡æ¯**:
```
No dashboards are active for the current data set.
Log directory: D:\Hacker\Sider_CAPTCHA_Solver\logs\tensorboard\1.1.0
```

**åŸå› åˆ†æ**:
1. TensorBoardåœ¨è®­ç»ƒå¼€å§‹å‰å°±è¢«è®¿é—®ï¼Œæ­¤æ—¶è¿˜æ²¡æœ‰å†™å…¥ä»»ä½•äº‹ä»¶æ–‡ä»¶
2. è®­ç»ƒåœ¨ç¬¬ä¸€ä¸ªepochå°±å´©æºƒï¼Œæ²¡æœ‰å®Œæˆä»»ä½•å®Œæ•´çš„batchè®°å½•

**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ ä½ - è¿™æ˜¯æ—¶åºé—®é¢˜ï¼Œä¸å½±å“è®­ç»ƒ

**è§£å†³æ–¹æ¡ˆ**:
- ç­‰å¾…è®­ç»ƒå¼€å§‹åå†è®¿é—®TensorBoard
- æˆ–è€…åœ¨è®­ç»ƒå´©æºƒä¿®å¤åï¼ŒTensorBoardä¼šè‡ªåŠ¨æ˜¾ç¤ºæ•°æ®

---

### é”™è¯¯2: å¼ é‡ç»´åº¦ä¸åŒ¹é… (è‡´å‘½é”™è¯¯) âš ï¸

**é”™è¯¯ä¿¡æ¯**:
```python
File "d:\Hacker\Sider_CAPTCHA_Solver\src\training\training_engine.py", line 394, in _focal_loss
    pos_loss = pos_loss * weight_mask
               ~~~~~~~~~^~~~~~~~~~~~~
RuntimeError: The size of tensor a (64) must match the size of tensor b (36) at non-singleton dimension 2
```

**é”™è¯¯ä½ç½®**: 
- æ–‡ä»¶: `src/training/training_engine.py`
- è¡Œå·: 394
- å‡½æ•°: `_focal_loss`

**åŸå› åˆ†æ**:

è¿™æ˜¯ä¸€ä¸ª**ä¸¥é‡çš„ç»´åº¦ä¸åŒ¹é…é—®é¢˜**ã€‚åœ¨è®¡ç®—focal lossæ—¶ï¼š
- `pos_loss` å¼ é‡ç»´åº¦: [B, H, W] å…¶ä¸­ W=64
- `weight_mask` å¼ é‡ç»´åº¦: [B, H, W] å…¶ä¸­ W=36

**æ ¹æœ¬åŸå› **:
1. **çƒ­åŠ›å›¾å°ºå¯¸ä¸ä¸€è‡´**: 
   - æ¨¡å‹è¾“å‡ºçš„çƒ­åŠ›å›¾å°ºå¯¸: 64Ã—128 (ä¸‹é‡‡æ ·4å€åçš„320Ã—160)
   - æ ‡ç­¾çƒ­åŠ›å›¾å°ºå¯¸å¯èƒ½æ˜¯: 36Ã—? (é”™è¯¯çš„ä¸‹é‡‡æ ·æˆ–resize)

2. **å¯èƒ½çš„è§¦å‘æ¡ä»¶**:
   - æ•°æ®é¢„å¤„ç†æ—¶çš„å°ºå¯¸è®¡ç®—é”™è¯¯
   - æ‰¹æ¬¡ä¸­æŸäº›æ ·æœ¬çš„å°ºå¯¸å¼‚å¸¸
   - çƒ­åŠ›å›¾ç”Ÿæˆæ—¶çš„ä¸‹é‡‡æ ·å› å­ä¸ä¸€è‡´

**æ·±å±‚æ¬¡åŸå› æ¨æµ‹**:
```python
# æœŸæœ›çš„å°ºå¯¸è®¡ç®—:
è¾“å…¥å›¾åƒ: 320Ã—160
ä¸‹é‡‡æ ·å› å­: 4
çƒ­åŠ›å›¾å°ºå¯¸: 80Ã—40

# å®é™…çœ‹åˆ°çš„:
pos_losså®½åº¦: 64
weight_maskå®½åº¦: 36

# å¯èƒ½åŸå› :
- ä¸åŒæ»‘å—å°ºå¯¸(30-50px)å¯¼è‡´çš„çƒ­åŠ›å›¾å°ºå¯¸å˜åŒ–
- æ‰¹æ¬¡å†…æ··åˆäº†ä¸åŒå°ºå¯¸çš„æ•°æ®
```

**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ é«˜ - é˜»å¡è®­ç»ƒè¿›ç¨‹

**è§£å†³æ–¹æ¡ˆ**:

#### ç«‹å³ä¿®å¤:
```python
# åœ¨ training_engine.py çš„ _focal_loss å‡½æ•°ä¸­æ·»åŠ å°ºå¯¸æ£€æŸ¥
def _focal_loss(self, pred, target, weight_mask=None):
    # æ·»åŠ è°ƒè¯•ä¿¡æ¯
    if weight_mask is not None:
        print(f"DEBUG: pred shape: {pred.shape}")
        print(f"DEBUG: target shape: {target.shape}")
        print(f"DEBUG: weight_mask shape: {weight_mask.shape}")
        
        # ç¡®ä¿ç»´åº¦åŒ¹é…
        if pred.shape != weight_mask.shape:
            # é€‰é¡¹1: è°ƒæ•´weight_maskå°ºå¯¸
            weight_mask = F.interpolate(
                weight_mask.unsqueeze(1), 
                size=pred.shape[-2:], 
                mode='bilinear', 
                align_corners=False
            ).squeeze(1)
            
            # é€‰é¡¹2: æŠ›å‡ºæ›´è¯¦ç»†çš„é”™è¯¯
            # raise ValueError(f"Shape mismatch: pred {pred.shape} vs weight_mask {weight_mask.shape}")
```

#### æ ¹æœ¬è§£å†³:
1. **æ£€æŸ¥æ•°æ®ç”Ÿæˆæµç¨‹**:
   - ç¡®ä¿æ‰€æœ‰çƒ­åŠ›å›¾ä½¿ç”¨ç›¸åŒçš„ä¸‹é‡‡æ ·å› å­
   - éªŒè¯NPYæ–‡ä»¶ä¸­çš„çƒ­åŠ›å›¾å°ºå¯¸ä¸€è‡´æ€§

2. **ç»Ÿä¸€å°ºå¯¸å®šä¹‰**:
   ```python
   # åœ¨é…ç½®ä¸­æ˜ç¡®å®šä¹‰
   OUTPUT_HEIGHT = 40  # 160 / 4
   OUTPUT_WIDTH = 80   # 320 / 4
   ```

---

### é”™è¯¯3: æ¨¡å‹ç»“æ„å›¾è­¦å‘Š

**é”™è¯¯ä¿¡æ¯**:
```
Encountering a dict at the output of the tracer might cause the trace to be incorrect
```

**åŸå› åˆ†æ**:
- æ¨¡å‹è¾“å‡ºæ˜¯å­—å…¸æ ¼å¼ `{'gap': ..., 'slider': ...}`
- PyTorchçš„traceræœŸæœ›è¾“å‡ºæ˜¯tupleæˆ–tensor

**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¢ ä½ - ä»…å½±å“å¯è§†åŒ–ï¼Œä¸å½±å“è®­ç»ƒ

**è§£å†³æ–¹æ¡ˆ**:
```python
# åœ¨ visualizer.py ä¸­ä¿®æ”¹
try:
    self.writer.add_graph(model, dummy_input, strict=False)  # æ·»åŠ strict=False
except Exception as e:
    self.logger.warning(f"æ— æ³•æ·»åŠ æ¨¡å‹ç»“æ„å›¾: {e}")
```

---

## ğŸ› ï¸ ä¿®å¤ä¼˜å…ˆçº§

### ä¼˜å…ˆçº§1 - ç«‹å³ä¿®å¤ (é˜»å¡é—®é¢˜)
**å¼ é‡ç»´åº¦ä¸åŒ¹é…**
- [ ] æ·»åŠ ç»´åº¦æ£€æŸ¥å’Œè°ƒè¯•ä¿¡æ¯
- [ ] å®ç°è‡ªåŠ¨ç»´åº¦å¯¹é½
- [ ] éªŒè¯æ•°æ®é¢„å¤„ç†çš„ä¸€è‡´æ€§

### ä¼˜å…ˆçº§2 - ç¨åä¿®å¤
**TensorBoardæ˜¾ç¤ºé—®é¢˜**
- [ ] ç¡®ä¿è®­ç»ƒå®Œæˆè‡³å°‘ä¸€ä¸ªbatchåå†æŸ¥çœ‹
- [ ] æ·»åŠ åˆå§‹åŒ–æ—¶çš„å ä½æ•°æ®

### ä¼˜å…ˆçº§3 - å¯é€‰ä¿®å¤
**æ¨¡å‹ç»“æ„å›¾**
- [ ] ä½¿ç”¨strict=Falseå‚æ•°
- [ ] æˆ–å°†æ¨¡å‹è¾“å‡ºæ”¹ä¸ºNamedTuple

---

## ğŸ“Š è°ƒè¯•æ­¥éª¤

### 1. æ”¶é›†æ›´å¤šä¿¡æ¯
```bash
# æ£€æŸ¥NPYæ–‡ä»¶çš„å®é™…å°ºå¯¸
python -c "
import numpy as np
import glob
files = glob.glob('data/processed/targets/train/*.npy')[:5]
for f in files:
    data = np.load(f, allow_pickle=True).item()
    print(f'{f}:')
    print(f'  heatmap_gap: {data[\"heatmap_gap\"].shape}')
    print(f'  heatmap_slider: {data[\"heatmap_slider\"].shape}')
"
```

### 2. ä¸´æ—¶ç»•è¿‡é”™è¯¯
åœ¨ `training_engine.py` ç¬¬394è¡Œå‰æ·»åŠ :
```python
if pos_loss.shape != weight_mask.shape:
    print(f"WARNING: Shape mismatch, skipping this batch")
    return torch.tensor(0.0, device=pred.device)
```

### 3. ç›‘æ§è®­ç»ƒ
```bash
# ä½¿ç”¨æ›´è¯¦ç»†çš„æ—¥å¿—
python scripts/training/train.py --debug
```

---

## ğŸ’¡ é¢„é˜²æªæ–½

1. **æ·»åŠ æ•°æ®éªŒè¯**:
   - åœ¨æ•°æ®åŠ è½½æ—¶æ£€æŸ¥æ‰€æœ‰å¼ é‡ç»´åº¦
   - åœ¨æŸå¤±è®¡ç®—å‰éªŒè¯è¾“å…¥è¾“å‡ºåŒ¹é…

2. **ç»Ÿä¸€é…ç½®ç®¡ç†**:
   - æ‰€æœ‰å°ºå¯¸ç›¸å…³å‚æ•°é›†ä¸­å®šä¹‰
   - é¿å…ç¡¬ç¼–ç çš„ç»´åº¦å€¼

3. **å¢å¼ºé”™è¯¯å¤„ç†**:
   - æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
   - è‡ªåŠ¨æ¢å¤æœºåˆ¶

---

## ğŸ“ æ€»ç»“

ä¸»è¦é—®é¢˜æ˜¯**å¼ é‡ç»´åº¦ä¸åŒ¹é…**ï¼Œè¿™æ˜¯ç”±äºçƒ­åŠ›å›¾ç”Ÿæˆæˆ–æ•°æ®é¢„å¤„ç†ä¸­çš„å°ºå¯¸ä¸ä¸€è‡´å¯¼è‡´çš„ã€‚éœ€è¦ï¼š

1. **ç«‹å³**: ä¿®å¤ç»´åº¦ä¸åŒ¹é…é—®é¢˜ï¼Œç¡®ä¿è®­ç»ƒèƒ½å¤Ÿè¿è¡Œ
2. **ä¹‹å**: éªŒè¯æ•´ä¸ªæ•°æ®pipelineçš„ä¸€è‡´æ€§
3. **é•¿æœŸ**: æ·»åŠ æ›´å¤šçš„æ•°æ®éªŒè¯å’Œé”™è¯¯å¤„ç†æœºåˆ¶

å»ºè®®å…ˆé€šè¿‡æ·»åŠ ç»´åº¦å¯¹é½ä»£ç æ¥å¿«é€Ÿæ¢å¤è®­ç»ƒï¼Œç„¶åå†æ·±å…¥è°ƒæŸ¥æ ¹æœ¬åŸå› ã€‚