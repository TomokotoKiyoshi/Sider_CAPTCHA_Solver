# GPUä¼˜åŒ–è¿›åº¦æŠ¥å‘Š (Windowsç³»ç»Ÿ)

## å·²å®Œæˆçš„ä¼˜åŒ– âœ…

### 1. æ··åˆç²¾åº¦é…ç½®ä¿®å¤ï¼ˆé—®é¢˜#1ï¼‰
- **æ–‡ä»¶**: `src/training/training_engine.py`
- **æ”¹åŠ¨**: ä¿®å¤äº†AMPé…ç½®è§£æï¼Œæ”¯æŒå¸ƒå°”å€¼å’Œå­—ç¬¦ä¸²é…ç½®
- **çŠ¶æ€**: âœ… å®Œæˆå¹¶å¯ç”¨
- **å½±å“**: é¢„æœŸæ€§èƒ½æå‡20-40%

### 2. ç¡¬ä»¶ä¼˜åŒ–åº”ç”¨ï¼ˆé—®é¢˜#3ï¼‰
- **æ–‡ä»¶**: 
  - `scripts/training/train.py`
  - `scripts/training/test_train.py`
- **æ”¹åŠ¨**: æ·»åŠ äº†`config_manager.apply_hardware_optimizations()`è°ƒç”¨
- **åŠŸèƒ½**: å¯ç”¨TF32åŠ é€Ÿã€cuDNNè‡ªåŠ¨è°ƒä¼˜
- **çŠ¶æ€**: âœ… å®Œæˆå¹¶å¯ç”¨
- **å½±å“**: é¢„æœŸæ€§èƒ½æå‡10-20%

---

## Windowsé™åˆ¶ âš ï¸

### torch.compileï¼ˆé—®é¢˜#2ï¼‰
- **é—®é¢˜**: Windowsä¸Šç¼ºå°‘Tritonæ”¯æŒï¼Œå¯¼è‡´torch.compileæ— æ³•ä½¿ç”¨
- **å½“å‰çŠ¶æ€**: å·²ç¦ç”¨ï¼ˆ`compile_model: false`ï¼‰
- **æ›¿ä»£æ–¹æ¡ˆ**: 
  1. ä½¿ç”¨WSL2è¿è¡ŒLinuxç‰ˆæœ¬ï¼ˆæ¨èï¼‰
  2. ç­‰å¾…PyTorchçš„Windowsç‰ˆæœ¬æ”¹è¿›
  3. ä½¿ç”¨å…¶ä»–ä¼˜åŒ–æ–¹æ³•è¡¥å¿

---

## å¯ç«‹å³åº”ç”¨çš„ä¼˜åŒ– ğŸ“‹

### 4. ä¼˜åŒ–æ‰¹é‡å¤§å°å’Œæ•°æ®åŠ è½½
ä¿®æ”¹ `config/training_config.yaml`:
```yaml
train:
  batch_size: 512          # ä»256å¢åŠ åˆ°512
  num_workers: 8           # ä»28å‡å°‘åˆ°8ï¼ˆWindowsä¸Šè¿‡å¤šworkersåè€Œæ…¢ï¼‰
  gradient_accumulation_steps: 2  # æ¢¯åº¦ç´¯ç§¯ï¼ˆæœ‰æ•ˆbatch=1024ï¼‰
  prefetch_factor: 2       # é¢„å–å› å­

optimizer:
  lr: 6.0e-4              # å› ä¸ºbatchå¢å¤§ï¼Œç›¸åº”æé«˜å­¦ä¹ ç‡
```

### 5. ä½¿ç”¨Fusedä¼˜åŒ–å™¨
ä¿®æ”¹ `src/training/training_engine.py` L169ï¼Œæ·»åŠ fusedå‚æ•°ï¼š
```python
optimizer = AdamW(
    self.model.parameters(),
    lr=opt_cfg['lr'],
    betas=opt_cfg.get('betas', [0.9, 0.999]),
    eps=opt_cfg.get('eps', 1e-8),
    weight_decay=opt_cfg.get('weight_decay', 0.05),
    fused=True  # æ·»åŠ æ­¤è¡Œï¼ˆéœ€è¦CUDA 11.0+ï¼‰
)
```

---

## é¢„æœŸæ•ˆæœï¼ˆWindowsç¯å¢ƒï¼‰

| ä¼˜åŒ–é¡¹ | çŠ¶æ€ | é¢„æœŸæå‡ |
|-------|------|----------|
| æ··åˆç²¾åº¦ä¿®å¤ | âœ… | +20-40% |
| ç¡¬ä»¶ä¼˜åŒ–(TF32) | âœ… | +10-20% |
| torch.compile | âŒ | 0%ï¼ˆWindowsä¸æ”¯æŒï¼‰ |
| æ‰¹é‡å¤§å°ä¼˜åŒ– | â³ | +20-30% |
| Fusedä¼˜åŒ–å™¨ | â³ | +3-5% |
| å‡å°‘num_workers | â³ | +5-10%ï¼ˆWindowsç‰¹æœ‰ï¼‰ |

**ç´¯è®¡å¯è¾¾**: 58-105%çš„æ€§èƒ½æå‡
**é¢„æœŸGPUåŠŸè€—**: 300W â†’ ~400-450W

---

## æµ‹è¯•å‘½ä»¤

```bash
# æµ‹è¯•è®­ç»ƒæ€§èƒ½ï¼ˆä½¿ç”¨å°æ•°æ®é›†ï¼‰
python scripts/training/test_train.py --epochs 1

# å®Œæ•´è®­ç»ƒ
python scripts/training/train.py

# ç›‘æ§GPUï¼ˆPowerShellï¼‰
nvidia-smi dmon -s pucvmet -i 0
```

---

## Windowsç‰¹å®šå»ºè®®

1. **WSL2æ–¹æ¡ˆ**ï¼ˆæ¨èï¼‰ï¼š
   - åœ¨WSL2ä¸­è¿è¡Œå¯ä»¥ä½¿ç”¨å®Œæ•´çš„torch.compileåŠŸèƒ½
   - æ€§èƒ½æ¥è¿‘åŸç”ŸLinux
   
2. **å‡å°‘CPUç“¶é¢ˆ**ï¼š
   - Windowsä¸Šnum_workersä¸å®œè¿‡å¤šï¼ˆå»ºè®®4-8ï¼‰
   - ä½¿ç”¨pin_memoryå’Œnon_blocking

3. **å†…å­˜ç®¡ç†**ï¼š
   - Windowsæ˜¾å­˜ç®¡ç†ä¸å¦‚Linuxé«˜æ•ˆ
   - å»ºè®®é¢„ç•™æ›´å¤šæ˜¾å­˜ä½™é‡

---

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³å¯åš**ï¼š
   - åº”ç”¨æ‰¹é‡å¤§å°ä¼˜åŒ–
   - æ·»åŠ Fusedä¼˜åŒ–å™¨
   - å‡å°‘num_workers

2. **æµ‹è¯•éªŒè¯**ï¼š
   - è¿è¡Œtest_train.pyç¡®è®¤ä¼˜åŒ–æ•ˆæœ
   - ç›‘æ§GPUåŠŸè€—å’Œåˆ©ç”¨ç‡

3. **é•¿æœŸæ–¹æ¡ˆ**ï¼š
   - è€ƒè™‘è¿ç§»åˆ°WSL2æˆ–Linuxç³»ç»Ÿ
   - ç­‰å¾…PyTorchæ”¹è¿›Windowsæ”¯æŒ

---

*æ›´æ–°æ—¶é—´: 2025-01-16*
*ç³»ç»Ÿç¯å¢ƒ: Windows 11 + RTX 5090*
*PyTorchç‰ˆæœ¬: 2.7.1+cu118*